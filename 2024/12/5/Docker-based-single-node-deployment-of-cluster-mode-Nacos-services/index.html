<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>基于Docker的单节点部署集群模式Nacos服务 | 宋导的笔记本</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">基于Docker的单节点部署集群模式Nacos服务</h1><a id="logo" href="/.">宋导的笔记本</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">基于Docker的单节点部署集群模式Nacos服务</h1><div class="post-meta">2024-12-05<span> | </span><span class="category"><a href="/categories/DevOps/">DevOps</a></span></div><div class="post-content"><h1 id="基于Docker的单节点部署集群模式Nacos服务"><a href="#基于Docker的单节点部署集群模式Nacos服务" class="headerlink" title="基于Docker的单节点部署集群模式Nacos服务"></a>基于Docker的单节点部署集群模式Nacos服务</h1><p>前情提要: <a target="_blank" rel="noopener" href="https://github.com/songdaoyuan/HKZC-DevOps-SDY-DOC/blob/master/0x00%20%E9%83%A8%E7%BD%B2%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/%E8%AE%B0%E5%BD%95%E7%94%B1%E4%BA%8ENacos%E4%B8%8D%E7%A8%B3%E5%AE%9A%E5%AF%BC%E8%87%B4gateway%E6%9C%8D%E5%8A%A1%E6%8A%A5CORS%E8%B7%A8%E5%9F%9F%E9%94%99%E8%AF%AF/%E8%AE%B0%E5%BD%95%E7%94%B1%E4%BA%8ENacos%E4%B8%8D%E7%A8%B3%E5%AE%9A%E5%AF%BC%E8%87%B4gateway%E6%9C%8D%E5%8A%A1%E6%8A%A5CORS%E8%B7%A8%E5%9F%9F%E9%94%99%E8%AF%AF.md">记录由于Nacos不稳定导致gateway服务报CORS跨域错误</a></p>
<p>为了解决这个问题, 但是我又不想专门为Nacos开几个虚拟机并且独占式的使用整个机器的资源, 所以这里选择了使用Docker在单机上部署三个Nacos服务组成集群</p>
<p>下图是Nacos官方文档中提供的集群部署架构图</p>
<p><img src="/2024/12/5/Docker-based-single-node-deployment-of-cluster-mode-Nacos-services/deploy-dns-vip-mode.svg" alt="deploy-dns-vip-mode"></p>
<p>本文中采用<code>域名+SLB</code>模式, 在NGINX上绑定Nacos服务的域名, 使用NG的负载均衡功能将流量转发给Nacos节点</p>
<h2 id="Docker镜像的构建"><a href="#Docker镜像的构建" class="headerlink" title="Docker镜像的构建"></a>Docker镜像的构建</h2><p>由于涉及到较多的自定义功能和版本的需求, 所以这里采用自主构建镜像的策略</p>
<p>在构建开始前, 确保构建时的文件目录结构如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nacos_2.0.3_cluster/</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── bin/</span><br><span class="line">│   └── docker-startup.sh</span><br><span class="line">└── conf/</span><br><span class="line">    └── application.properties</span><br></pre></td></tr></table></figure>

<h3 id="Dockerfile的内容"><a href="#Dockerfile的内容" class="headerlink" title="Dockerfile的内容"></a><code>Dockerfile</code>的内容</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;dauyohaN &lt;song.daoyuan@qq.com&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&quot;1.0&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> document=<span class="string">&quot;https://songdaoyuan.github.io/2024/12/5/Docker-based-single-node-deployment-of-cluster-mode-Nacos-services&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设定Nacos的版本和热修复标识</span></span><br><span class="line"><span class="keyword">ARG</span> NACOS_VERSION=<span class="number">2.0</span>.<span class="number">3</span></span><br><span class="line"><span class="keyword">ARG</span> HOT_FIX_FLAG=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27;</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apk update &amp;&amp; apk add --no-cache \</span></span><br><span class="line"><span class="language-bash">    openjdk8-jre-base \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    iputils \</span></span><br><span class="line"><span class="language-bash">    ncurses \</span></span><br><span class="line"><span class="language-bash">    vim \</span></span><br><span class="line"><span class="language-bash">    libcurl \</span></span><br><span class="line"><span class="language-bash">    bash \</span></span><br><span class="line"><span class="language-bash">    libc6-compat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> MODE=<span class="string">&quot;cluster&quot;</span> \</span><br><span class="line">    PREFER_HOST_MODE=<span class="string">&quot;ip&quot;</span>\</span><br><span class="line">    BASE_DIR=<span class="string">&quot;/home/nacos&quot;</span> \</span><br><span class="line">    CLASSPATH=<span class="string">&quot;.:/home/nacos/conf:$CLASSPATH&quot;</span> \</span><br><span class="line">    CLUSTER_CONF=<span class="string">&quot;/home/nacos/conf/cluster.conf&quot;</span> \</span><br><span class="line">    FUNCTION_MODE=<span class="string">&quot;all&quot;</span> \</span><br><span class="line">    JAVA_HOME=<span class="string">&quot;/usr/lib/jvm/java-1.8-openjdk&quot;</span> \</span><br><span class="line">    NACOS_USER=<span class="string">&quot;nacos&quot;</span> \</span><br><span class="line">    JAVA=<span class="string">&quot;/usr/lib/jvm/java-1.8-openjdk/bin/java&quot;</span> \</span><br><span class="line">    JVM_XMS=<span class="string">&quot;1g&quot;</span> \</span><br><span class="line">    JVM_XMX=<span class="string">&quot;1g&quot;</span> \</span><br><span class="line">    JVM_XMN=<span class="string">&quot;512m&quot;</span> \</span><br><span class="line">    JVM_MS=<span class="string">&quot;128m&quot;</span> \</span><br><span class="line">    JVM_MMS=<span class="string">&quot;320m&quot;</span> \</span><br><span class="line">    NACOS_DEBUG=<span class="string">&quot;n&quot;</span> \</span><br><span class="line">    TOMCAT_ACCESSLOG_ENABLED=<span class="string">&quot;false&quot;</span> \</span><br><span class="line">    TIME_ZONE=<span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$BASE_DIR</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载并安装 Nacos</span></span><br><span class="line"><span class="comment"># 注意这里curl使用了代理, 如果不需要记得删掉 --proxy http://172.28.12.252:7897</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; curl --proxy http://172.28.12.252:7897 -SL <span class="string">&quot;https://github.com/alibaba/nacos/releases/download/<span class="variable">$&#123;NACOS_VERSION&#125;</span><span class="variable">$&#123;HOT_FIX_FLAG&#125;</span>/nacos-server-<span class="variable">$&#123;NACOS_VERSION&#125;</span>.tar.gz&quot;</span> -o nacos-server.tar.gz \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; tar -xzvf nacos-server.tar.gz -C /home \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf nacos-server.tar.gz /home/nacos/bin/* /home/nacos/conf/*.properties /home/nacos/conf/*.example /home/nacos/conf/nacos-mysql.sql \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TIME_ZONE</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TIME_ZONE</span> &gt; /etc/timezone</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> bin/docker-startup.sh bin/docker-startup.sh</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> conf/application.properties conf/application.properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置启动日志目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p logs \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">touch</span> logs/start.out \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">ln</span> -sf /dev/stdout logs/start.out \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">ln</span> -sf /dev/stderr logs/start.out \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chmod</span> +x bin/docker-startup.sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8848</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">9848</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;bin/docker-startup.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>基础镜像选择最新的<code>alpine</code>, Nacos选择<code>2.0.3</code>, 安装了一些必备的工具</p>
<p>由于Alpine使用的是musl libc 而不是 glibc, 会导致启动时加载 RocksDB 相关的动态链接库时出现错误, 通过安装glibc兼容包来修复这个问题</p>
<p>如果你在拉取镜像的过程中遇到了网络问题, 可以参考<a href="https://songdaoyuan.github.io/2024/7/15/Configuring-Proxies-for-Docker-Three-Network-Proxy-Configurations-for-Docker-in-Detail/">为Docker配置代理 - 详解Docker的三种网络代理配置</a></p>
<p>在镜像内部使用<code>curl</code>下载GitHub的Nacos Release使用了代理, 如果不需要记得删掉<code>--proxy http://172.28.12.252:7897</code></p>
<h3 id="docker-startup-sh的内容"><a href="#docker-startup-sh的内容" class="headerlink" title="docker-startup.sh的内容"></a><code>docker-startup.sh</code>的内容</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"><span class="built_in">export</span> CUSTOM_SEARCH_NAMES=<span class="string">&quot;application&quot;</span></span><br><span class="line"><span class="built_in">export</span> CUSTOM_SEARCH_LOCATIONS=file:<span class="variable">$&#123;BASE_DIR&#125;</span>/conf/</span><br><span class="line"><span class="built_in">export</span> MEMBER_LIST=<span class="string">&quot;<span class="variable">$MEMBER_LIST</span>&quot;</span></span><br><span class="line">PLUGINS_DIR=<span class="string">&quot;/home/nacos/plugins/peer-finder&quot;</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">print_servers</span></span>() &#123;</span><br><span class="line">   <span class="keyword">if</span> [[ ! -d <span class="string">&quot;<span class="variable">$&#123;PLUGINS_DIR&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;<span class="string">&quot;<span class="variable">$CLUSTER_CONF</span>&quot;</span></span><br><span class="line">    <span class="keyword">for</span> server <span class="keyword">in</span> <span class="variable">$&#123;NACOS_SERVERS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$server</span>&quot;</span> &gt;&gt;<span class="string">&quot;<span class="variable">$CLUSTER_CONF</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    bash <span class="variable">$PLUGINS_DIR</span>/plugin.sh</span><br><span class="line">    <span class="built_in">sleep</span> 30</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">join_if_exist</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$2</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;$1<span class="variable">$2</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#===========================================================================================</span></span><br><span class="line"><span class="comment"># JVM Configuration</span></span><br><span class="line"><span class="comment">#===========================================================================================</span></span><br><span class="line">Xms=$(join_if_exist <span class="string">&quot;-Xms&quot;</span> <span class="variable">$&#123;JVM_XMS&#125;</span>)</span><br><span class="line">Xmx=$(join_if_exist <span class="string">&quot;-Xmx&quot;</span> <span class="variable">$&#123;JVM_XMX&#125;</span>)</span><br><span class="line">Xmn=$(join_if_exist <span class="string">&quot;-Xmn&quot;</span> <span class="variable">$&#123;JVM_XMN&#125;</span>)</span><br><span class="line">XX_MS=$(join_if_exist <span class="string">&quot;-XX:MetaspaceSize=&quot;</span> <span class="variable">$&#123;JVM_MS&#125;</span>)</span><br><span class="line">XX_MMS=$(join_if_exist <span class="string">&quot;-XX:MaxMetaspaceSize=&quot;</span> <span class="variable">$&#123;JVM_MMS&#125;</span>)</span><br><span class="line"></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:CMSInitiatingOccupancyFraction=70 -XX:+CMSParallelRemarkEnabled -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+CMSClassUnloadingEnabled -XX:SurvivorRatio=8 &quot;</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;MODE&#125;</span>&quot;</span> == <span class="string">&quot;standalone&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> <span class="variable">$Xms</span> <span class="variable">$Xmx</span> <span class="variable">$Xmn</span>&quot;</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.standalone=true&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;EMBEDDED_STORAGE&#125;</span>&quot;</span> == <span class="string">&quot;embedded&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -DembeddedStorage=true&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -server <span class="variable">$Xms</span> <span class="variable">$Xmx</span> <span class="variable">$Xmn</span> <span class="variable">$XX_MS</span> <span class="variable">$XX_MMS</span>&quot;</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;NACOS_DEBUG&#125;</span>&quot;</span> == <span class="string">&quot;y&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Xdebug -Xrunjdwp:transport=dt_socket,address=9555,server=y,suspend=n&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -XX:-OmitStackTraceInFastThrow -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=<span class="variable">$&#123;BASE_DIR&#125;</span>/logs/java_heapdump.hprof&quot;</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -XX:-UseLargePages&quot;</span></span><br><span class="line">  print_servers</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#===========================================================================================</span></span><br><span class="line"><span class="comment"># Setting system properties</span></span><br><span class="line"><span class="comment">#===========================================================================================</span></span><br><span class="line"><span class="comment"># set  mode that Nacos Server function of split</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;FUNCTION_MODE&#125;</span>&quot;</span> == <span class="string">&quot;config&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.functionMode=config&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$&#123;FUNCTION_MODE&#125;</span>&quot;</span> == <span class="string">&quot;naming&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.functionMode=naming&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># set nacos server ip</span></span><br><span class="line"><span class="keyword">if</span> [[ ! -z <span class="string">&quot;<span class="variable">$&#123;NACOS_SERVER_IP&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.server.ip=<span class="variable">$&#123;NACOS_SERVER_IP&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ ! -z <span class="string">&quot;<span class="variable">$&#123;USE_ONLY_SITE_INTERFACES&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.inetutils.use-only-site-local-interfaces=<span class="variable">$&#123;USE_ONLY_SITE_INTERFACES&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ ! -z <span class="string">&quot;<span class="variable">$&#123;PREFERRED_NETWORKS&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.inetutils.preferred-networks=<span class="variable">$&#123;PREFERRED_NETWORKS&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ ! -z <span class="string">&quot;<span class="variable">$&#123;IGNORED_INTERFACES&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.inetutils.ignored-interfaces=<span class="variable">$&#123;IGNORED_INTERFACES&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### If turn on auth system:</span></span><br><span class="line"><span class="keyword">if</span> [[ ! -z <span class="string">&quot;<span class="variable">$&#123;NACOS_AUTH_ENABLE&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.core.auth.enabled=<span class="variable">$&#123;NACOS_AUTH_ENABLE&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;PREFER_HOST_MODE&#125;</span>&quot;</span> == <span class="string">&quot;hostname&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.preferHostnameOverIp=true&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.member.list=<span class="variable">$&#123;MEMBER_LIST&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">JAVA_MAJOR_VERSION=$(<span class="variable">$JAVA</span> -version 2&gt;&amp;1 | sed -E -n <span class="string">&#x27;s/.* version &quot;([0-9]*).*$/\1/p&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$JAVA_MAJOR_VERSION</span>&quot;</span> -ge <span class="string">&quot;9&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Xlog:gc*:file=<span class="variable">$&#123;BASE_DIR&#125;</span>/logs/nacos_gc.log:time,tags:filecount=10,filesize=102400&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  JAVA_OPT_EXT_FIX=<span class="string">&quot;-Djava.ext.dirs=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre/lib/ext:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib/ext&quot;</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Xloggc:<span class="variable">$&#123;BASE_DIR&#125;</span>/logs/nacos_gc.log -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=100M&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dloader.path=<span class="variable">$&#123;BASE_DIR&#125;</span>/plugins,<span class="variable">$&#123;BASE_DIR&#125;</span>/plugins/health,<span class="variable">$&#123;BASE_DIR&#125;</span>/plugins/cmdb,<span class="variable">$&#123;BASE_DIR&#125;</span>/plugins/selector&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.home=<span class="variable">$&#123;BASE_DIR&#125;</span>&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -jar <span class="variable">$&#123;BASE_DIR&#125;</span>/target/nacos-server.jar&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> <span class="variable">$&#123;JAVA_OPT_EXT&#125;</span>&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> --spring.config.additional-location=<span class="variable">$&#123;CUSTOM_SEARCH_LOCATIONS&#125;</span>&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> --spring.config.name=<span class="variable">$&#123;CUSTOM_SEARCH_NAMES&#125;</span>&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> --logging.config=<span class="variable">$&#123;BASE_DIR&#125;</span>/conf/nacos-logback.xml&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> --server.max-http-header-size=524288&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Nacos is starting, you can docker logs your container&quot;</span></span><br><span class="line"><span class="built_in">exec</span> <span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="application-properties的内容"><a href="#application-properties的内容" class="headerlink" title="application.properties的内容"></a><code>application.properties</code>的内容</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># spring</span><br><span class="line">server.servlet.contextPath=$&#123;SERVER_SERVLET_CONTEXTPATH:/nacos&#125;</span><br><span class="line">server.contextPath=/nacos</span><br><span class="line">server.port=$&#123;NACOS_APPLICATION_PORT:8848&#125;</span><br><span class="line">server.tomcat.accesslog.max-days=30</span><br><span class="line">server.tomcat.accesslog.pattern=%h %l %u %t &quot;%r&quot; %s %b %D %&#123;User-Agent&#125;i %&#123;Request-Source&#125;i</span><br><span class="line">server.tomcat.accesslog.enabled=$&#123;TOMCAT_ACCESSLOG_ENABLED:false&#125;</span><br><span class="line">server.error.include-message=ALWAYS</span><br><span class="line"># default current work dir</span><br><span class="line">server.tomcat.basedir=file:.</span><br><span class="line">#*************** Config Module Related Configurations ***************#</span><br><span class="line">### Deprecated configuration property, it is recommended to use `spring.sql.init.platform` replaced.</span><br><span class="line">#spring.datasource.platform=$&#123;SPRING_DATASOURCE_PLATFORM:&#125;</span><br><span class="line">spring.sql.init.platform=$&#123;SPRING_DATASOURCE_PLATFORM:&#125;</span><br><span class="line">nacos.cmdb.dumpTaskInterval=3600</span><br><span class="line">nacos.cmdb.eventTaskInterval=10</span><br><span class="line">nacos.cmdb.labelTaskInterval=300</span><br><span class="line">nacos.cmdb.loadDataAtStart=false</span><br><span class="line">db.num=$&#123;MYSQL_DATABASE_NUM:1&#125;</span><br><span class="line">db.url.0=jdbc:mysql://$&#123;MYSQL_SERVICE_HOST&#125;:$&#123;MYSQL_SERVICE_PORT:3306&#125;/$&#123;MYSQL_SERVICE_DB_NAME&#125;?$&#123;MYSQL_SERVICE_DB_PARAM:characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useSSL=false&#125;</span><br><span class="line">db.user.0=$&#123;MYSQL_SERVICE_USER&#125;</span><br><span class="line">db.password.0=$&#123;MYSQL_SERVICE_PASSWORD&#125;</span><br><span class="line">## DB connection pool settings</span><br><span class="line">db.pool.config.connectionTimeout=$&#123;DB_POOL_CONNECTION_TIMEOUT:30000&#125;</span><br><span class="line">db.pool.config.validationTimeout=10000</span><br><span class="line">db.pool.config.maximumPoolSize=20</span><br><span class="line">db.pool.config.minimumIdle=2</span><br><span class="line">### The auth system to use, currently only &#x27;nacos&#x27; and &#x27;ldap&#x27; is supported:</span><br><span class="line">nacos.core.auth.system.type=$&#123;NACOS_AUTH_SYSTEM_TYPE:nacos&#125;</span><br><span class="line">### worked when nacos.core.auth.system.type=nacos</span><br><span class="line">### The token expiration in seconds:</span><br><span class="line">nacos.core.auth.plugin.nacos.token.expire.seconds=$&#123;NACOS_AUTH_TOKEN_EXPIRE_SECONDS:18000&#125;</span><br><span class="line">### The default token:</span><br><span class="line">nacos.core.auth.plugin.nacos.token.secret.key=$&#123;NACOS_AUTH_TOKEN:&#125;</span><br><span class="line">### Turn on/off caching of auth information. By turning on this switch, the update of auth information would have a 15 seconds delay.</span><br><span class="line">nacos.core.auth.caching.enabled=$&#123;NACOS_AUTH_CACHE_ENABLE:false&#125;</span><br><span class="line">nacos.core.auth.enable.userAgentAuthWhite=$&#123;NACOS_AUTH_USER_AGENT_AUTH_WHITE_ENABLE:false&#125;</span><br><span class="line">nacos.core.auth.server.identity.key=$&#123;NACOS_AUTH_IDENTITY_KEY:&#125;</span><br><span class="line">nacos.core.auth.server.identity.value=$&#123;NACOS_AUTH_IDENTITY_VALUE:&#125;</span><br><span class="line">## spring security config</span><br><span class="line">### turn off security</span><br><span class="line">nacos.security.ignore.urls=$&#123;NACOS_SECURITY_IGNORE_URLS:/,/error,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-fe/public/**,/v1/auth/**,/v1/console/health/**,/actuator/**,/v1/console/server/**&#125;</span><br><span class="line"># metrics for elastic search</span><br><span class="line">management.metrics.export.elastic.enabled=false</span><br><span class="line">management.metrics.export.influx.enabled=false</span><br><span class="line">nacos.naming.distro.taskDispatchThreadCount=10</span><br><span class="line">nacos.naming.distro.taskDispatchPeriod=200</span><br><span class="line">nacos.naming.distro.batchSyncKeyCount=1000</span><br><span class="line">nacos.naming.distro.initDataRatio=0.9</span><br><span class="line">nacos.naming.distro.syncRetryDelay=5000</span><br><span class="line">nacos.naming.data.warmup=true</span><br><span class="line">nacos.console.ui.enabled=true</span><br><span class="line">nacos.core.param.check.enabled=true</span><br></pre></td></tr></table></figure>

<h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><p>在确保路径结构正确, 文件已经准备就绪后, 就可以开始打包镜像了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build --no-cache -t nacos_cluster:v2.0.3 .</span><br></pre></td></tr></table></figure>

<h2 id="使用docker-compose管理服务"><a href="#使用docker-compose管理服务" class="headerlink" title="使用docker-compose管理服务"></a>使用docker-compose管理服务</h2><h3 id="docker-compose-yml文件的配置和说明"><a href="#docker-compose-yml文件的配置和说明" class="headerlink" title="docker-compose.yml文件的配置和说明"></a><code>docker-compose.yml</code>文件的配置和说明</h3><p>为了方便快速启动多个节点并且管理节点的配置, 使用docker-compose进行容器编排</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nacos-node1:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">nacos-node1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos-node1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos_cluster:v2.0.3</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cluster-logs/nacos-node1:/home/nacos/logs</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7848:7848&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8848:8848&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9868:9848&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9850:9849&quot;</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos-cluster.env</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">nacos-node2:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">nacos-node2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos_cluster:v2.0.3</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos-node2</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cluster-logs/nacos-node2:/home/nacos/logs</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7849:7848&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8849:8848&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9869:9848&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9851:9849&quot;</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos-cluster.env</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">nacos-node3:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">nacos-node3</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos_cluster:v2.0.3</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos-node3</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cluster-logs/nacos-node3:/home/nacos/logs</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7850:7848&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8850:8848&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9870:9848&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9852:9849&quot;</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos-cluster.env</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure>

<p>观察compose文件可知, 在启动Nacos集群的过程中, <strong>没有启动和初始化MySQL实例</strong>, 是因为本次的目标是从单点部署的Nacos迁移到集群部署, 可以沿用原有的MySQL数据库, 如果你是初始部署, 需要借鉴官方的<a target="_blank" rel="noopener" href="https://github.com/nacos-group/nacos-docker/blob/master/README_ZH.md">Nacos Docker部署文档</a>, 额外增加启动和初始化MySQL数据库的操作</p>
<p>在compose文件中我们能观察到容器映射了很多的端口, 原因在官方的<a target="_blank" rel="noopener" href="https://nacos.io/docs/latest/manual/admin/deployment/deployment-overview/#1-Nacos%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84">部署架构说明</a>可知:</p>
<blockquote>
<p>Nacos2.X版本新增了gRPC的通信方式, 因此需要增加2个端口<br>新增端口是在配置的主端口(server.port, 默认8848)基础上, 进行一定偏移量自动生成, 具体端口内容及偏移量请参考如下</p>
</blockquote>
<table>
<thead>
<tr>
<th>端口</th>
<th>与主端口的偏移量</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>9848</td>
<td>1000</td>
<td>客户端gRPC请求服务端端口，用于客户端向服务端发起连接和请求</td>
</tr>
<tr>
<td>9849</td>
<td>1001</td>
<td>服务端gRPC请求服务端端口，用于服务间同步等</td>
</tr>
<tr>
<td>7848</td>
<td>-1000</td>
<td>Jraft请求服务端端口，用于处理服务端间的Raft相关请求</td>
</tr>
</tbody></table>
<h3 id="nacos-cluster-env文件的配置和说明"><a href="#nacos-cluster-env文件的配置和说明" class="headerlink" title="nacos-cluster.env文件的配置和说明"></a><code>nacos-cluster.env</code>文件的配置和说明</h3><p>compose中依赖的<code>nacos-cluster.env</code>文件内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PREFER_HOST_MODE=hostname</span><br><span class="line">NACOS_SERVERS=nacos-node1:8848 nacos-node2:8848 nacos-node3:8848</span><br><span class="line">SPRING_DATASOURCE_PLATFORM=mysql</span><br><span class="line">MYSQL_SERVICE_HOST=192.168.6.192</span><br><span class="line">MYSQL_SERVICE_DB_NAME=nacos</span><br><span class="line">MYSQL_SERVICE_PORT=3306</span><br><span class="line">MYSQL_SERVICE_USER=root</span><br><span class="line">MYSQL_SERVICE_PASSWORD=123456</span><br><span class="line">MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useSSL=false&amp;allowPublicKeyRetrieval=true</span><br><span class="line">NACOS_AUTH_IDENTITY_KEY=2222</span><br><span class="line">NACOS_AUTH_IDENTITY_VALUE=2xxx</span><br><span class="line">NACOS_AUTH_TOKEN=SecretKey012345678901234567890123456789012345678901234567890123456789</span><br></pre></td></tr></table></figure>

<p>这个文件主要控制了Nacos的节点发现、数据源、鉴权这三个核心配置, 根据你实际的配置替换成正确的选项即可</p>
<h3 id="集群的启动"><a href="#集群的启动" class="headerlink" title="集群的启动"></a>集群的启动</h3><p>在准备完成后, 检查下docker-compose的目录结构是否如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nacos_2.0.3_cluster/</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">└── nacos-cluster.env</span><br></pre></td></tr></table></figure>

<p>再检查下compose文件和配置文件中主机名是否一致、MySQL数据源配置是否正确, 确认无误后, 启动集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br><span class="line">docker logs nacos-node1</span><br><span class="line">---</span><br><span class="line">2024-12-05 14:55:23,831 INFO Nacos started successfully <span class="keyword">in</span> cluster mode. use external storage</span><br></pre></td></tr></table></figure>

<h2 id="NGINX负载均衡的配置"><a href="#NGINX负载均衡的配置" class="headerlink" title="NGINX负载均衡的配置"></a>NGINX负载均衡的配置</h2><p>使用NGINX实现负载均衡, 主要是配置<code>upstream</code>代码块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream test-nacos.com &#123;</span><br><span class="line">    # server 192.168.6.192:8848;</span><br><span class="line">    server 192.168.6.141:8848 max_fails=3 fail_timeout=5s;</span><br><span class="line">    server 192.168.6.141:8849 max_fails=3 fail_timeout=5s;</span><br><span class="line">    server 192.168.6.141:8850 max_fails=3 fail_timeout=5s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完成后重启NGINX, 访问域名, 在集群管理-节点列表里面查看当前Nacos节点的状态</p>
<p><img src="/2024/12/5/Docker-based-single-node-deployment-of-cluster-mode-Nacos-services/nacos-node-status.png" alt="nacos-node-status"></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nacos/" rel="tag">Nacos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker-compose/" rel="tag">docker-compose</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/12/9/Configuring-Cloud-Hosting-to-Connect-to-AliCloud-K8s/">配置云主机连接到阿里云K8s</a><a class="next" href="/2024/11/29/Build-Hexo-personal-blog-and-static-resource-file-management/">搭建Hexo个人博客和静态资源文件的管理</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/avatar.jpg"/></a><p>理可顿悟, 事需渐修</p><a class="info-icon" href="https://twitter.com/username" title="Twitter" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:song.daoyuan@qq.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/songdaoyuan" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E7%AC%94/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Alipine-Linux/" style="font-size: 15px;">Alipine Linux</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E5%AE%B9%E5%99%A8%E4%B8%8E%E8%99%9A%E6%8B%9F%E5%8C%96/" style="font-size: 15px;">容器与虚拟化</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 15px;">杂谈</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 15px;">随笔</a> <a href="/tags/Jenkins/" style="font-size: 15px;">Jenkins</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Maven/" style="font-size: 15px;">Maven</a> <a href="/tags/K8s/" style="font-size: 15px;">K8s</a> <a href="/tags/%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0/" style="font-size: 15px;">滚动更新</a> <a href="/tags/%E6%96%87%E4%BB%B6%E6%B8%85%E7%90%86/" style="font-size: 15px;">文件清理</a> <a href="/tags/SSH/" style="font-size: 15px;">SSH</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size: 15px;">代理</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 15px;">操作系统</a> <a href="/tags/%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/" style="font-size: 15px;">文件管理</a> <a href="/tags/LVM/" style="font-size: 15px;">LVM</a> <a href="/tags/%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/" style="font-size: 15px;">磁盘管理</a> <a href="/tags/crontab/" style="font-size: 15px;">crontab</a> <a href="/tags/NGINX/" style="font-size: 15px;">NGINX</a> <a href="/tags/fail2ban/" style="font-size: 15px;">fail2ban</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8/" style="font-size: 15px;">系统安全</a> <a href="/tags/Nacos/" style="font-size: 15px;">Nacos</a> <a href="/tags/docker-compose/" style="font-size: 15px;">docker-compose</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/OSS/" style="font-size: 15px;">OSS</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 15px;">正则表达式</a> <a href="/tags/TCP-UDP/" style="font-size: 15px;">TCP/UDP</a> <a href="/tags/Zookeeper/" style="font-size: 15px;">Zookeeper</a> <a href="/tags/%E7%A7%BB%E5%8A%A8%E4%BA%91/" style="font-size: 15px;">移动云</a> <a href="/tags/NAT%E7%BD%91%E5%85%B3/" style="font-size: 15px;">NAT网关</a> <a href="/tags/Bitnami/" style="font-size: 15px;">Bitnami</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/Promtail/" style="font-size: 15px;">Promtail</a> <a href="/tags/Loki/" style="font-size: 15px;">Loki</a> <a href="/tags/Grafana/" style="font-size: 15px;">Grafana</a> <a href="/tags/%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1/" style="font-size: 15px;">日志服务</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/Harbor/" style="font-size: 15px;">Harbor</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 15px;">性能优化</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/12/18/Why-do-you-often-feel-that-there-is-no-point-in-living/">为什么会经常觉得人活着没有意思</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/16/Configure-authorization-for-K8s-to-pull-harbor-repository-images/">配置K8s拉取私有Harbor仓库镜像的授权认证</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/9/Configuring-Cloud-Hosting-to-Connect-to-AliCloud-K8s/">配置云主机连接到阿里云K8s</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/5/Docker-based-single-node-deployment-of-cluster-mode-Nacos-services/">基于Docker的单节点部署集群模式Nacos服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/11/29/Build-Hexo-personal-blog-and-static-resource-file-management/">搭建Hexo个人博客和静态资源文件的管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/8/30/Automatically-clean-up-docker-resources-using-crontab-timed-tasks/">使用crontab定时任务自动清理docker资源和冗余日志</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/8/21/Compiling-and-Installing-NGINX-Adding-the-Forward-Proxy-Module-and-Stream-Module/">编译安装NGINX——为NGINX添加正向代理模块转发局域网其他主机流量、Stream模块转发TCP/UDP请求</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/8/12/Storage-Data-Migration-for-Docker/">Docker的存储数据迁移</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/8/5/Unlocking-the-default-memory-size-limit-for-node.js-compilations/">解除node.js编译时默认内存大小限制</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/7/30/Solve-the-mount-permission-problem-of-Bitnami-image/">解决Bitnami的镜像的挂载权限问题</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://gitee.com/songdaoyuan" title="Gitee" target="_blank">Gitee</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">宋导的笔记本.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>
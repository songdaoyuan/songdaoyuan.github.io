<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>移动云ECS初始化、系统配置、中间件和应用部署、网络架构文档 | 宋导的笔记本</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">移动云ECS初始化、系统配置、中间件和应用部署、网络架构文档</h1><a id="logo" href="/.">宋导的笔记本</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">移动云ECS初始化、系统配置、中间件和应用部署、网络架构文档</h1><div class="post-meta">2024-07-26<span> | </span><span class="category"><a href="/categories/DevOps/">DevOps</a></span></div><div class="post-content"><h1 id="移动云ECS初始化、系统配置、中间件和应用部署、网络架构文档"><a href="#移动云ECS初始化、系统配置、中间件和应用部署、网络架构文档" class="headerlink" title="移动云ECS初始化、系统配置、中间件和应用部署、网络架构文档"></a>移动云ECS初始化、系统配置、中间件和应用部署、网络架构文档</h1><p>这篇文档以移动云中的几台ECS为例, 记录了ECS的初始化、中间件和应用部署的示例、ECS集群搭建的实例、还有负载均衡的配置实例</p>
<h2 id="0x00-必备组件安装和初始化"><a href="#0x00-必备组件安装和初始化" class="headerlink" title="0x00 必备组件安装和初始化"></a>0x00 必备组件安装和初始化</h2><p>在一切开始之前, 首先初始化移动云的云公网IP和NAT配置, 具体参考<a href="https://songdaoyuan.github.io/2024/7/22/ecloud-NAT-Gateway-and-Elastic-Public-IP-Configuration/">NAT网关和弹性公网IP配置</a></p>
<h3 id="0x00-0-初始化额外数据盘"><a href="#0x00-0-初始化额外数据盘" class="headerlink" title="0x00-0 初始化额外数据盘"></a>0x00-0 初始化额外数据盘</h3><p>以其中一台ECS为例, 操作系统 Ubuntu2204 LTS, 有100G系统盘和额外挂载的500G云硬盘<br><img src="/2024/7/26/Ecloud-ECS-initialization-and-configuration/Viewing-Mounted-Cloud-Drive.png" alt="查看已经挂载的云硬盘"></p>
<p>移动云控制台显示硬盘已经挂载但未被初始化, 使用<code>fdisk -l</code>校验</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@ecs-hykg-app:/# fdisk -l</span><br><span class="line">Disk /dev/sda: 100 GiB, 107374182400 bytes, 209715200 sectors</span><br><span class="line">Disk model: QEMU HARDDISK   </span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0x65f2787d</span><br><span class="line"></span><br><span class="line">Device     Boot Start       End   Sectors  Size Id Type</span><br><span class="line">/dev/sda1  *     2048 209715166 209713119  100G 83 Linux</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 500 GiB, 536870912000 bytes, 1048576000 sectors</span><br><span class="line">Disk model: QEMU HARDDISK   </span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br></pre></td></tr></table></figure>

<p>对硬盘进行分区, <code>fdisk /dev/sdb</code>, 系列命令如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">root@ecs-hykg-app:/# fdisk /dev/sdb</span><br><span class="line"></span><br><span class="line">Welcome to fdisk (util-linux 2.37.2).</span><br><span class="line">Changes will remain <span class="keyword">in</span> memory only, <span class="keyword">until</span> you decide to write them.</span><br><span class="line">Be careful before using the write <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table.</span><br><span class="line">Created a new DOS disklabel with disk identifier 0xd9d54c85.</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n  <span class="comment"># n 新建分区</span></span><br><span class="line">Partition <span class="built_in">type</span></span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended (container <span class="keyword">for</span> logical partitions)</span><br><span class="line">Select (default p): p  <span class="comment"># p 主分区</span></span><br><span class="line">Partition number (1-4, default 1): 1  <span class="comment"># 分1个区</span></span><br><span class="line">First sector (2048-1048575999, default 2048): <span class="comment"># 默认2048</span></span><br><span class="line">Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (2048-1048575999, default 1048575999): <span class="comment"># 默认最后一个分区位置</span></span><br><span class="line"></span><br><span class="line">Created a new partition 1 of <span class="built_in">type</span> <span class="string">&#x27;Linux&#x27;</span> and of size 500 GiB.</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): p  <span class="comment"># 查看当前分区</span></span><br><span class="line">Disk /dev/sdb: 500 GiB, 536870912000 bytes, 1048576000 sectors</span><br><span class="line">Disk model: QEMU HARDDISK   </span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0xd9d54c85</span><br><span class="line"></span><br><span class="line">Device     Boot Start        End    Sectors  Size Id Type</span><br><span class="line">/dev/sdb1        2048 1048575999 1048573952  500G 83 Linux</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): wq  <span class="comment"># 退出</span></span><br><span class="line">The partition table has been altered.</span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure>

<p>创建挂载点: <code>mkdir /data</code></p>
<p>磁盘格式化为<code>ext4</code>: <code>mkfs.ext4 /dev/sdb1</code></p>
<p>挂载: <code>mount /dev/sdb1 /data/</code></p>
<p><strong>持久化挂载, 避免重启后失效</strong>: 需要将配置文件写入<code>fstab</code></p>
<p>获取需要操作盘的<code>UUID</code>信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">blkid /dev/sdb1</span><br><span class="line">/dev/sdb1: UUID=<span class="string">&quot;f704f222-ba2d-41df-b1d8-f31715d9ba67&quot;</span> BLOCK_SIZE=<span class="string">&quot;4096&quot;</span> TYPE=<span class="string">&quot;ext4&quot;</span> PARTUUID=<span class="string">&quot;d9d54c85-01&quot;</span></span><br></pre></td></tr></table></figure>

<p>编辑<code>/etc/fstab</code>文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将上面获取的 UUID 和计划挂载的路径写入</span></span><br><span class="line">vim /etc/fstab</span><br><span class="line">UUID=f704f222-ba2d-41df-b1d8-f31715d9ba67 /data ext4 defaults 1 1</span><br></pre></td></tr></table></figure>

<p>大容量硬盘可以使用<code>parted</code>分区, 使用<code>GPT</code>格式分区表</p>
<p>完整教程参考<a target="_blank" rel="noopener" href="https://ecloud.10086.cn/op-help-center/doc/article/48750">移动云磁盘初始化指南</a></p>
<p>或者使用初始化脚本<a target="_blank" rel="noopener" href="https://github.com/songdaoyuan/HKZC-DevOps-Tools/blob/master/scripts/LinuxVMDiskAutoInitialize2.sh">LinuxVMDiskAutoInitialize2.sh</a></p>
<h3 id="0x00-1-初始化SSH允许远程登录"><a href="#0x00-1-初始化SSH允许远程登录" class="headerlink" title="0x00-1 初始化SSH允许远程登录"></a>0x00-1 初始化SSH允许远程登录</h3><p>安装 openssh-server 服务, 配置允许 root 用户远程登录, 使用强密码, 监听 22 端口</p>
<p>由于需要映射 SSH 服务到公网, 密码验证的安全性较差, 所以需要额外配置安全组规则, 使用白名单模式只放行 hysz 的公网IP</p>
<p><img src="/2024/7/26/Ecloud-ECS-initialization-and-configuration/Configuring-Security-Group-Rules.png" alt="配置安全组规则"></p>
<h2 id="0x01-ECS-HYKG-APP的中间件和应用部署示例"><a href="#0x01-ECS-HYKG-APP的中间件和应用部署示例" class="headerlink" title="0x01 ECS-HYKG-APP的中间件和应用部署示例"></a>0x01 ECS-HYKG-APP的中间件和应用部署示例</h2><p>以<code>ECS-HYKG-APP</code>这台ECS为例, 介绍下主应用服务器的部署逻辑</p>
<h3 id="0x01-0-直接部署服务——以Nacos的部署为例"><a href="#0x01-0-直接部署服务——以Nacos的部署为例" class="headerlink" title="0x01-0 直接部署服务——以Nacos的部署为例"></a>0x01-0 直接部署服务——以Nacos的部署为例</h3><p>最主要需要注意的事项是相关部署的文件或者程序需要在<code>/home/</code>归档, 便于以后查阅</p>
<p>实机部署<code>Nacos 2.0.3</code>, 可以参考<a target="_blank" rel="noopener" href="https://nacos.io/docs/v2/quickstart/quick-start/">Nacos官方文档</a></p>
<p>部署程序依赖的依赖的<code>JDK 1.8+</code>环境, 验证安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ecs-hykg-app:~# apt install openjdk-8-jdk</span><br><span class="line"><span class="comment"># ···</span></span><br><span class="line">root@ecs-hykg-app:~# <span class="built_in">which</span> java</span><br><span class="line">/usr/bin/java</span><br><span class="line">root@ecs-hykg-app:~# java -version</span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_422&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_422-8u422-b05-1~22.04-b05)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.422-b05, mixed mode)</span><br></pre></td></tr></table></figure>

<p>下载 Nacos 安装包, 安装到<code>/opt/nacos-2.0.3</code>路径, 软链接到<code>/home</code></p>
<p>使用程序中自带的<code>SQL Schema</code>脚本初始化 MySQL 数据库, 修改 Nacos 配置文件, 配置数据库的连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 数据库连接信息配置</span><br><span class="line">#*************** Config Module Related Configurations ***************#</span><br><span class="line">### If use MySQL as datasource:</span><br><span class="line">spring.datasource.platform=mysql</span><br><span class="line"></span><br><span class="line">### Count of DB:</span><br><span class="line">db.num=1</span><br><span class="line"></span><br><span class="line">### Connect URL of DB:</span><br><span class="line">db.url.0=jdbc:mysql://ip:port/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span><br><span class="line">db.user.0=nacos</span><br><span class="line">db.password.0=nacos</span><br></pre></td></tr></table></figure>

<p>启动 Nacos 服务, 验证 8848 端口是否被 java 程序监听, 即可判断是否启动成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/nacos-2.0.3/bi</span><br><span class="line">./startup.sh -m standalone</span><br><span class="line">netstat -tulnp | grep 8848</span><br></pre></td></tr></table></figure>

<p>如果需要集群话部署, 可以参考<a href="https://songdaoyuan.github.io/2024/12/5/Docker-based-single-node-deployment-of-cluster-mode-Nacos-services/">基于Docker的单节点部署集群模式Nacos服务</a></p>
<h3 id="0x01-1-通过容器部署后端服务——以OA服务为例"><a href="#0x01-1-通过容器部署后端服务——以OA服务为例" class="headerlink" title="0x01-1 通过容器部署后端服务——以OA服务为例"></a>0x01-1 通过容器部署后端服务——以OA服务为例</h3><p>首先是完成 Docker 的安装, 可以使用运维脚本<a target="_blank" rel="noopener" href="https://github.com/songdaoyuan/HKZC-DevOps-Tools/blob/master/scripts/InstallDocker.sh">InstallDocker.sh</a>安装Docker及相关组件</p>
<h4 id="Docker数据目录的迁移"><a href="#Docker数据目录的迁移" class="headerlink" title="Docker数据目录的迁移"></a>Docker数据目录的迁移</h4><p>之前初始化了数据盘, 现在需要将 Docker 等<strong>存储空间占用较大的程序或日志放置在数据盘</strong>中</p>
<p>找到 Docker 的配置文件<code>daemon.json</code>, 修改<code>data-root</code>的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;data-root&quot;</span>: <span class="string">&quot;/data/docker&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">chmod</span> -R 755 /data/docker</span><br></pre></td></tr></table></figure>

<h4 id="配置镜像源的授权"><a href="#配置镜像源的授权" class="headerlink" title="配置镜像源的授权"></a>配置镜像源的授权</h4><p>找到 Docker 的授权文件<code>config.json</code>, 修改<code>auths</code>选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;auths&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;harbor.domain.com&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;auth&quot;</span>: <span class="string">&quot;YourAuthToken&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完成就重启守护进程和 Docker 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h4 id="docker-compose的部署"><a href="#docker-compose的部署" class="headerlink" title="docker-compose的部署"></a>docker-compose的部署</h4><p>根据系统架构在 Github 拉取最新的<a target="_blank" rel="noopener" href="https://github.com/docker/compose/releases">Release</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/bin</span><br><span class="line">wget https://github.com/docker/compose/releases/download/v2.32.0/docker-compose-linux-x86_64</span><br><span class="line"><span class="built_in">mv</span> docker-compose-linux-x86_64 docker-compose &amp;&amp; <span class="built_in">chmod</span> +x docker-compose</span><br></pre></td></tr></table></figure>

<p>在构建<code>docker-compose</code>应用时, 记得也将日志目录映射到数据盘<code>/data</code>目录中</p>
<h4 id="编译并部署OA服务"><a href="#编译并部署OA服务" class="headerlink" title="编译并部署OA服务"></a>编译并部署OA服务</h4><h5 id="Jenkins的构建脚本配置"><a href="#Jenkins的构建脚本配置" class="headerlink" title="Jenkins的构建脚本配置"></a>Jenkins的构建脚本配置</h5><p>首先使用 Maven 工具将源码编译成一个 Jar 包, 然后基于 JDK8 的基础镜像构建后端服务, Jenkins构建脚本如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">set -exu</span><br><span class="line">cat &lt;&lt; EOF &gt; Dockerfile</span><br><span class="line">FROM  alpine_jdk8u301:v1</span><br><span class="line">LABEL org.opencontainers.image.authors=&quot;songdaoyuan@focus-in.cn&quot;</span><br><span class="line">ENV TZ=Asia/Shanghai</span><br><span class="line">ENV LANG=zh_CN.UTF-8</span><br><span class="line">WORKDIR /project</span><br><span class="line">COPY $target $JOB_NAME.jar</span><br><span class="line">CMD java -server -Xms1g -Xmx2g -Dserver.port=8080 -jar $JOB_NAME.jar --spring.profiles.active=prod</span><br><span class="line">EXPOSE 8080</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送到 harbor 仓库</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">同时推送版本号标签和latest标签</span></span><br><span class="line">docker build -t harbor.domain.com/hykg/$JOB_NAME:v$BUILD_NUMBER .</span><br><span class="line">docker tag harbor.domain.com/hykg/$JOB_NAME:v$BUILD_NUMBER harbor.domain.com/hykg/$JOB_NAME:latest</span><br><span class="line">docker push harbor.domain.com/hykg/$JOB_NAME:v$BUILD_NUMBER</span><br><span class="line">docker push harbor.domain.com/hykg/$JOB_NAME:latest</span><br><span class="line">docker rmi harbor.domain.com/hykg/$JOB_NAME:v$BUILD_NUMBER</span><br><span class="line">docker rmi harbor.domain.com/hykg/$JOB_NAME:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$ECLOUD_HYKG_APP_HOST</span>实际指向移动云的NAT-弹性IP, 通过端口可以免密连接到不同的服务器</span></span><br><span class="line">ssh -p 10022 root@$ECLOUD_HYKG_APP_HOST &quot;cd /home/docker-compose/$JOB_NAME/ &amp;&amp;  bash update.sh&quot;</span><br></pre></td></tr></table></figure>

<p>构建完成后镜像被推送到 harbor 仓库, 最后一次构建完成的镜像会被打上版本标签 <code>v$BUILD_NUMBER</code> 和 <code>latest</code></p>
<h5 id="docker-compose-yml的和update-sh的配置"><a href="#docker-compose-yml的和update-sh的配置" class="headerlink" title="docker-compose.yml的和update.sh的配置"></a>docker-compose.yml的和update.sh的配置</h5><p>这两个文件和Jenkins构建脚本一起实现了<strong>全自动构建与更新</strong>的流程</p>
<p><strong>docker-compose.yml</strong>的内容</p>
<p>在服务器的<code>/home/docker-compose/$JOB_NAME/</code>路径存放着<code>docker-compose.yml</code>文件和控制镜像更新的<code>update.sh</code>脚本, 这里以OA中的<code>prod-basic-gateway</code>服务为例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">prod-basic-gateway:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">harbor.domain.com/hykg/prod-basic-gateway:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">prod-basic-gateway</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8081:8080&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/data/logs/focusin-log/prod:/var/logs/focusin/&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">docker-network</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">docker-network:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>可以看到容器使用了预先创建好的一个名为 docker-network 的桥接网络, 组建了容器间的大内网环境, 日志则持久化到数据盘中</p>
<p>这里可以考虑兼容运维习惯, 将<code>/data/logs/</code>软链接到<code>/var/log</code>目录</p>
<p><strong>update.sh</strong>的内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 更新并且重启容器</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;正在更新 192.168.0.11:8081 网关服务 镜像&quot;</span></span><br><span class="line">docker pull harbor.domain.com/hykg/prod-basic-gateway:latest</span><br><span class="line">docker-compose down &amp;&amp; docker-compose up -d</span><br><span class="line">docker system prune -f</span><br></pre></td></tr></table></figure>

<p>运行脚本后会首先拉取标签为<code>latest</code>的镜像, 可以保证每次都能获取到最新版本的镜像, 然后重启并且应用新的镜像, 最后使用<code>docker system prune -f</code>可以删除旧的镜像</p>
<h3 id="0x01-2-配置日志映射服务"><a href="#0x01-2-配置日志映射服务" class="headerlink" title="0x01-2 配置日志映射服务"></a>0x01-2 配置日志映射服务</h3><h4 id="部署Promtail-Loki-Grafana-PLG架构-的日志服务"><a href="#部署Promtail-Loki-Grafana-PLG架构-的日志服务" class="headerlink" title="部署Promtail+Loki+Grafana (PLG架构)的日志服务"></a>部署Promtail+Loki+Grafana (PLG架构)的日志服务</h4><p>这个是推荐的方案, 可以参考之前的文章<a href="https://songdaoyuan.github.io/2024/7/4/Deploying-Promtail-Loki-Grafana-logging-service/">部署Promtail+Loki+Grafana (PLG架构)的日志服务</a></p>
<h4 id="快速搭建一个HTTP服务器来应急使用"><a href="#快速搭建一个HTTP服务器来应急使用" class="headerlink" title="快速搭建一个HTTP服务器来应急使用"></a>快速搭建一个HTTP服务器来应急使用</h4><p>在特定路径启用一个基于 python 的 http 服务器, 监听 9988 端口, 然后在 NG 上配置反向代理, 通过公网 IP 加端口即可看到日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/logs/focusin-log/prod</span><br><span class="line">python3 -m http.server 9988</span><br></pre></td></tr></table></figure>

<h2 id="0x02-ECS-Zookeeper-0x集群部署示例"><a href="#0x02-ECS-Zookeeper-0x集群部署示例" class="headerlink" title="0x02 ECS-Zookeeper-0x集群部署示例"></a>0x02 ECS-Zookeeper-0x集群部署示例</h2><p>以<code>ECS-Zookeeper-0x</code>这三台ECS为例, 介绍下基于 Docker 的集群部署</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hutao722/p/9668023.html">参考文档ZK集群部署</a></p>
<h3 id="0x02-0-配置节点的hosts解析"><a href="#0x02-0-配置节点的hosts解析" class="headerlink" title="0x02-0 配置节点的hosts解析"></a>0x02-0 配置节点的hosts解析</h3><p>编辑<code>/etc/hosts</code>文件, 将 IP 和节点简称写入文件, 便于后续的节点发现和通信, 下面的命令在三台主机上都需要执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"><span class="comment">#zk cluster</span></span><br><span class="line">192.168.0.18 ecs-zookeeper-01</span><br><span class="line">192.168.0.10 ecs-zookeeper-02</span><br><span class="line">192.168.0.16 ecs-zookeeper-03</span><br><span class="line"><span class="comment">#zk cluster tiny</span></span><br><span class="line">192.168.0.18 ecs-zk-01</span><br><span class="line">192.168.0.10 ecs-zk-02</span><br><span class="line">192.168.0.16 ecs-zk-03</span><br><span class="line"><span class="comment">#zk cluster ultra tiny</span></span><br><span class="line">192.168.0.18 zk-01</span><br><span class="line">192.168.0.10 zk-02</span><br><span class="line">192.168.0.16 zk-03</span><br></pre></td></tr></table></figure>

<h3 id="0x02-1-配置节点之间的SSH免密登录"><a href="#0x02-1-配置节点之间的SSH免密登录" class="headerlink" title="0x02-1 配置节点之间的SSH免密登录"></a>0x02-1 配置节点之间的SSH免密登录</h3><p>三台主机之间需要配置SSH免密登录, 便于交换文件和信息, 下面的命令在三台主机上都需要执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id zk-01</span><br><span class="line">ssh-copy-id zk-02</span><br><span class="line">ssh-copy-id zk-03</span><br></pre></td></tr></table></figure>

<h3 id="0x02-2-使用容器部署Zookeeper服务"><a href="#0x02-2-使用容器部署Zookeeper服务" class="headerlink" title="0x02-2 使用容器部署Zookeeper服务"></a>0x02-2 使用容器部署Zookeeper服务</h3><h4 id="安装配置Docker"><a href="#安装配置Docker" class="headerlink" title="安装配置Docker"></a>安装配置Docker</h4><p>参考上面的 Docker 部署流程, 部署完成后拉取镜像备用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull harbor.domain.com/hykg/zookeeper:3.5.10</span><br></pre></td></tr></table></figure>

<h4 id="Zookeeper配置文件的持久化挂载"><a href="#Zookeeper配置文件的持久化挂载" class="headerlink" title="Zookeeper配置文件的持久化挂载"></a>Zookeeper配置文件的持久化挂载</h4><p>主机上<code>/home/</code>建立挂载目录和 zookeeper 配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /home/zookeeper-3.5.10/conf</span><br><span class="line"><span class="built_in">mkdir</span> -p /home/zookeeper-3.5.10/data</span><br><span class="line"><span class="built_in">cd</span> /home/zookeeper-3.5.10/conf</span><br><span class="line"></span><br><span class="line">vim zoo.cfg</span><br><span class="line"><span class="comment"># 添加以下内容</span></span><br><span class="line">clientPort=2181</span><br><span class="line">dataDir=/data</span><br><span class="line">dataLogDir=/data/log</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">autopurge.snapRetainCount=3</span><br><span class="line">autopurge.purgeInterval=0</span><br><span class="line">maxClientCnxns=60</span><br><span class="line">server.1=192.168.0.18:2888:3888</span><br><span class="line">server.2=192.168.0.10:2888:3888</span><br><span class="line">server.3=192.168.0.16:2888:3888</span><br><span class="line"><span class="comment"># 为每个机器都分配对应的id, 这里是以机器 1 为例</span></span><br><span class="line"><span class="built_in">cd</span> ../data/</span><br><span class="line"><span class="built_in">touch</span> myid &amp;&amp; <span class="built_in">echo</span> 1 &gt; myid</span><br></pre></td></tr></table></figure>

<h4 id="容器的启动和停止脚本"><a href="#容器的启动和停止脚本" class="headerlink" title="容器的启动和停止脚本"></a>容器的启动和停止脚本</h4><p>启动脚本<code>RunZooKeeperCluster.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim RunZooKeeperCluster.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker run  --network host -v /home/zookeeper-3.5.10/data:/data -v /home/zookeeper-3.5.10/conf:/conf --name zookeeper -d harbor.domain.com/hykg/zookeeper:3.5.10</span><br></pre></td></tr></table></figure>

<p>!!!<strong>注意</strong><br>    这里必须使用 <strong>host</strong> 网络模式, 很重要！！！<br>    不清楚就查阅 docker 中网络模式的区别</p>
<p>停止脚本<code>StopZooKeeperCluster.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim StopZooKeeperCluster.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker stop zookeeper</span><br></pre></td></tr></table></figure>

<p>在三台 ECS 上依次启动容器, 等待一段时间后自动组成 Zookeeper 集群</p>
<h2 id="0x03-ECS-Nginx-Master-Slave-Web的部署"><a href="#0x03-ECS-Nginx-Master-Slave-Web的部署" class="headerlink" title="0x03 ECS-Nginx-Master&#x2F;Slave&#x2F;Web的部署"></a>0x03 ECS-Nginx-Master&#x2F;Slave&#x2F;Web的部署</h2><p>以<code>ECS-Nginx-Master</code>这台 ECS 为例, 介绍下 NGINX 的部署流程</p>
<h3 id="0x03-0-编译所需包的准备"><a href="#0x03-0-编译所需包的准备" class="headerlink" title="0x03-0 编译所需包的准备"></a>0x03-0 编译所需包的准备</h3><p>由于需要一些额外的功能, 这里选择了通过编译安装<code>NGINX 1.20.2</code></p>
<p>体检将<code>ngx_http_proxy_connect_module-0.0.7</code>模块和<code>NGINX</code>源码解压</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ecs-nginx-master:/home/source# tar -xzf nginx-1.20.2.tar.gz ngx_http_proxy_connect_module-0.0.7.tar.gz</span><br><span class="line"><span class="comment"># ···</span></span><br><span class="line">root@ecs-nginx-master:/home/source# <span class="built_in">ls</span></span><br><span class="line">nginx-1.20.2  nginx-1.20.2.tar.gz  ngx_http_proxy_connect_module-0.0.7  ngx_http_proxy_connect_module-0.0.7.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="0x03-1-修补并编译NGINX"><a href="#0x03-1-修补并编译NGINX" class="headerlink" title="0x03-1 修补并编译NGINX"></a>0x03-1 修补并编译NGINX</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@ecs-nginx-master:/home/source# <span class="built_in">cd</span> nginx-1.20.2/</span><br><span class="line"><span class="comment"># 打补丁</span></span><br><span class="line">root@ecs-nginx-master:/home/source/nginx-1.20.2# patch -p1 &lt; /home/source/ngx_http_proxy_connect_module-0.0.7/patch/proxy_connect_rewrite_1018.patch </span><br><span class="line">patching file src/http/ngx_http_core_module.c</span><br><span class="line">patching file src/http/ngx_http_parse.c</span><br><span class="line">patching file src/http/ngx_http_request.c</span><br><span class="line">patching file src/http/ngx_http_request.h</span><br><span class="line">patching file src/http/ngx_http_variables.c</span><br><span class="line"></span><br><span class="line"><span class="comment"># build-essential：这是编译软件包所必需的一组工具，包括gcc、g++、make等。</span></span><br><span class="line"><span class="comment"># libpcre3 和 libpcre3-dev：PCRE库支持正则表达式，Nginx的HTTP模块需要它来解析正则表达式。</span></span><br><span class="line"><span class="comment"># zlib1g 和 zlib1g-dev：zlib库用于对HTTP包的内容做gzip格式的压缩。</span></span><br><span class="line"><span class="comment"># libssl-dev：OpenSSL库，如果你需要支持HTTPS，那么就需要这个库。</span></span><br><span class="line"><span class="comment"># libgd-dev：GD库，虽然不是所有情况下都需要，但某些模块可能需要它。</span></span><br><span class="line">apt update &amp;&amp; apt upgrade</span><br><span class="line">apt install build-essential libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev libgd-dev -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP 模块</span></span><br><span class="line"><span class="comment"># --with-http_ssl_module：启用SSL模块，用于支持HTTPS。</span></span><br><span class="line"><span class="comment"># --with-http_stub_status_module：启用状态统计模块，提供Nginx的状态信息。</span></span><br><span class="line"><span class="comment"># --with-http_gzip_static_module：启用对静态文件的Gzip压缩支持。</span></span><br><span class="line"><span class="comment"># --with-http_realip_module：启用Real IP模块，用于获取真实的客户端IP地址。</span></span><br><span class="line"><span class="comment"># Stream 模块</span></span><br><span class="line"><span class="comment"># --with-stream：启用TCP和UDP代理模块</span></span><br><span class="line">./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-http_stub_status_module --with-http_gzip_static_module --with-http_realip_module --with-stream --add-module=/home/source/ngx_http_proxy_connect_module-0.0.7</span><br><span class="line"><span class="comment">#编译和安装Nginx</span></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>兼容运维习惯, 软连接文件夹到<code>/etc/nginx</code>, 软连接可执行文件到<code>/usr/local/bin</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc &amp;&amp; <span class="built_in">ln</span> -s /usr/local/nginx/ ./nginx</span><br><span class="line"><span class="built_in">cd</span> /usr/local/bin &amp;&amp; <span class="built_in">ln</span> -s /usr/local/nginx/sbin/nginx ./nginx</span><br></pre></td></tr></table></figure>

<h3 id="0x03-2-编辑NGINX配置文件"><a href="#0x03-2-编辑NGINX配置文件" class="headerlink" title="0x03-2 编辑NGINX配置文件"></a>0x03-2 编辑NGINX配置文件</h3><p>首先创建日志文件夹, 然后修改 NGINX 配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /var/log/nginx</span><br><span class="line">vim nginx.conf</span><br></pre></td></tr></table></figure>

<p>下面是主配置文件<code>nginx.conf</code>的示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">user root;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log notice;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">   worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">  include /usr/local/nginx/conf/mime.types;</span><br><span class="line"></span><br><span class="line">  default_type text/html;</span><br><span class="line">  log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">  access_log /var/log/nginx/access.log main;</span><br><span class="line"></span><br><span class="line">  sendfile on;</span><br><span class="line">  tcp_nopush on;</span><br><span class="line">  tcp_nodelay on;</span><br><span class="line">  keepalive_timeout 300s;</span><br><span class="line">  client_body_timeout 300s;</span><br><span class="line">  proxy_send_timeout 300s;</span><br><span class="line">  proxy_read_timeout 300s;</span><br><span class="line">  proxy_connect_timeout 300s;</span><br><span class="line">  client_body_buffer_size 1024k;</span><br><span class="line">  gzip on;</span><br><span class="line">  gzip_min_length 10k;</span><br><span class="line">  gzip_buffers 4 32k;</span><br><span class="line">  gzip_http_version 1.1;</span><br><span class="line">  gzip_comp_level 5;</span><br><span class="line">  gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript;</span><br><span class="line">  gzip_vary on;</span><br><span class="line">  server_names_hash_max_size 1024;</span><br><span class="line">  server_names_hash_bucket_size 512;</span><br><span class="line">  client_max_body_size 1024m;</span><br><span class="line"></span><br><span class="line">  # 引入 项目的配置文件 和 工具网站</span><br><span class="line">  include /etc/nginx/sites-enabled/*/*/*.conf;</span><br><span class="line">  include /etc/nginx/tools/*.conf;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">  # 引入 TCP/UDP 的四层代理</span><br><span class="line">  include /etc/nginx/stream-enabled/*/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由配置文件可知</p>
<ul>
<li><p>后端的配置文件放置在:</p>
<p><code>/etc/nginx/sites-enabled/prod/server/server.conf</code></p>
</li>
<li><p>前端的配置文件放置在:</p>
<p><code>/etc/nginx/sites-enabled/prod/proxy-web/proxy-web.conf</code></p>
</li>
<li><p>中间件的配置文件放置在:</p>
<p><code>/etc/nginx/tools/nacos.conf</code></p>
</li>
<li><p>TCP&#x2F;UDP的反代配置文件在:</p>
<p><code>/etc/nginx/stream-enabled/prod/mysql.conf</code></p>
</li>
</ul>
<h3 id="0x03-3-使用Systemd管理NGINX服务"><a href="#0x03-3-使用Systemd管理NGINX服务" class="headerlink" title="0x03-3 使用Systemd管理NGINX服务"></a>0x03-3 使用Systemd管理NGINX服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[Unit]</span></span><br><span class="line"><span class="string">Description=The NGINX HTTP and reverse proxy server</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string">Wants=network.target</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string"># 解除 65535 线程的限制, 不需要可以注释掉</span></span><br><span class="line"><span class="string"># LimitNOFILE=65535</span></span><br><span class="line"><span class="string">Type=forking</span></span><br><span class="line"><span class="string">PIDFile=/var/run/nginx.pid</span></span><br><span class="line"><span class="string">ExecStartPre=/usr/local/nginx/sbin/nginx -t</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="string">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span></span><br><span class="line"><span class="string">ExecStop=/usr/local/nginx/sbin/nginx -s stop</span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>

<p>如果在之前的编译过程中修改了路径, 或者修改了 NGINX 的配置文件, 这里创建<code>Systemd</code>服务的时候需要同步修改路径</p>
<p>启用并且验证服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br><span class="line">systemctl start nginx</span><br></pre></td></tr></table></figure>

<h4 id="偶发的Systemd错误处理"><a href="#偶发的Systemd错误处理" class="headerlink" title="偶发的Systemd错误处理"></a>偶发的Systemd错误处理</h4><p>偶发情况下, 使用<code>Systemd</code>管理 NGINX 会出现报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.service: Can&#x27;t open PID file /run/nginx.pid (yet?) after start-post: Operation not permitted</span><br></pre></td></tr></table></figure>

<p>实际上 pid 文件存在, 但是报错信息显示无法找到该文件, 在<code>Systemd</code>的配置文件中加上延迟启动参数可以解决这个问题</p>
<h3 id="0x03-4-前端应用与NGINX-WEB"><a href="#0x03-4-前端应用与NGINX-WEB" class="headerlink" title="0x03-4 前端应用与NGINX WEB"></a>0x03-4 前端应用与NGINX WEB</h3><h4 id="前端应用的编译与发布"><a href="#前端应用的编译与发布" class="headerlink" title="前端应用的编译与发布"></a>前端应用的编译与发布</h4><p>上面主要介绍的是 NGINX Master 的配置文件, 对于前端应用来说, 流量首先需要通过 NGINX Master 转发到 NGINX Web, 最后才是转发给前端应用</p>
<p>在 Jenkins 构建流水线中, 前端服务编译完成后, 构建脚本将 dist 包分发到 ECS-Nginx-Web 服务器上, 完整脚本如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">set -exu</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">控制 node 的内存分配, 解决编译 OOM 的问题</span></span><br><span class="line">export NODE_OPTIONS=&quot;--max-old-space-size=8192&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">前端环境编译</span></span><br><span class="line"></span><br><span class="line">npm install yarn -g</span><br><span class="line"></span><br><span class="line">yarn install</span><br><span class="line"></span><br><span class="line">node --max-old-space-size=8192 $(which yarn) run build:$env</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$ECLOUD_HYKG_APP_HOST</span> 实际指向的是移动云的NAT网关, 通过不同端口即可到达不同的服务器, 10025 是ECS-NG-WEB</span></span><br><span class="line">scp -r -P 10025  ./dist/* $ECLOUD_HYKG_APP_HOST:/data/$env/$JOB_NAME</span><br></pre></td></tr></table></figure>

<h4 id="NGINX的双层代理"><a href="#NGINX的双层代理" class="headerlink" title="NGINX的双层代理"></a>NGINX的双层代理</h4><h5 id="ECS-Nginx-Web的一层代理"><a href="#ECS-Nginx-Web的一层代理" class="headerlink" title="ECS-Nginx-Web的一层代理"></a>ECS-Nginx-Web的一层代理</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 81;</span><br><span class="line">    root /data/prod/prod-fs-oa-web-fd/;</span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.html;</span><br><span class="line">        try_files $uri $uri/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 /404.html;</span><br><span class="line">    location = /40x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ECS-Nginx-Master的二层代理"><a href="#ECS-Nginx-Master的二层代理" class="headerlink" title="ECS-Nginx-Master的二层代理"></a>ECS-Nginx-Master的二层代理</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">upstream prod-fs-oa-web-fd.com &#123;</span><br><span class="line">    server 192.168.0.2:81;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 18081;</span><br><span class="line">    server_name 192.168.0.13;</span><br><span class="line">    access_log /var/log/nginx/prod-fs-oa-web-fd.access.log main;</span><br><span class="line">    client_max_body_size 0;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://prod-fs-oa-web-fd.com/;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_cookie_path / /;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x04-移动云网络架构说明"><a href="#0x04-移动云网络架构说明" class="headerlink" title="0x04 移动云网络架构说明"></a>0x04 移动云网络架构说明</h2><p><img src="/2024/7/26/Ecloud-ECS-initialization-and-configuration/Ecloud-Network-Infrastructure.png" alt="移动云的网络架构"></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NGINX/" rel="tag">NGINX</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nacos/" rel="tag">Nacos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Zookeeper/" rel="tag">Zookeeper</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%B9%E5%99%A8%E4%B8%8E%E8%99%9A%E6%8B%9F%E5%8C%96/" rel="tag">容器与虚拟化</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/7/30/Solve-the-mount-permission-problem-of-Bitnami-image/">解决Bitnami的镜像的挂载权限问题</a><a class="next" href="/2024/7/22/ecloud-NAT-Gateway-and-Elastic-Public-IP-Configuration/">移动云NAT网关和弹性公网IP配置</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/avatar.jpg"/></a><p>理可顿悟, 事需渐修</p><a class="info-icon" href="https://twitter.com/username" title="Twitter" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:song.daoyuan@qq.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/songdaoyuan" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E7%AC%94/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Alipine-Linux/" style="font-size: 15px;">Alipine Linux</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E5%AE%B9%E5%99%A8%E4%B8%8E%E8%99%9A%E6%8B%9F%E5%8C%96/" style="font-size: 15px;">容器与虚拟化</a> <a href="/tags/Jenkins/" style="font-size: 15px;">Jenkins</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Maven/" style="font-size: 15px;">Maven</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 15px;">杂谈</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 15px;">随笔</a> <a href="/tags/JumpServer/" style="font-size: 15px;">JumpServer</a> <a href="/tags/%E5%A0%A1%E5%9E%92%E6%9C%BA/" style="font-size: 15px;">堡垒机</a> <a href="/tags/K8s/" style="font-size: 15px;">K8s</a> <a href="/tags/%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0/" style="font-size: 15px;">滚动更新</a> <a href="/tags/%E6%96%87%E4%BB%B6%E6%B8%85%E7%90%86/" style="font-size: 15px;">文件清理</a> <a href="/tags/SSH/" style="font-size: 15px;">SSH</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 15px;">操作系统</a> <a href="/tags/%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/" style="font-size: 15px;">文件管理</a> <a href="/tags/Systemd/" style="font-size: 15px;">Systemd</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/tags/%E5%BC%80%E6%BA%90%E9%95%9C%E5%83%8F%E7%AB%99/" style="font-size: 15px;">开源镜像站</a> <a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size: 15px;">代理</a> <a href="/tags/%E6%97%B6%E9%97%B4%E5%92%8C%E6%97%B6%E5%8C%BA/" style="font-size: 15px;">时间和时区</a> <a href="/tags/LVM/" style="font-size: 15px;">LVM</a> <a href="/tags/%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/" style="font-size: 15px;">磁盘管理</a> <a href="/tags/crontab/" style="font-size: 15px;">crontab</a> <a href="/tags/NGINX/" style="font-size: 15px;">NGINX</a> <a href="/tags/fail2ban/" style="font-size: 15px;">fail2ban</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8/" style="font-size: 15px;">系统安全</a> <a href="/tags/Nacos/" style="font-size: 15px;">Nacos</a> <a href="/tags/docker-compose/" style="font-size: 15px;">docker-compose</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/OSS/" style="font-size: 15px;">OSS</a> <a href="/tags/TCP-UDP/" style="font-size: 15px;">TCP/UDP</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 15px;">正则表达式</a> <a href="/tags/Zookeeper/" style="font-size: 15px;">Zookeeper</a> <a href="/tags/%E7%A7%BB%E5%8A%A8%E4%BA%91/" style="font-size: 15px;">移动云</a> <a href="/tags/NAT%E7%BD%91%E5%85%B3/" style="font-size: 15px;">NAT网关</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/Bitnami/" style="font-size: 15px;">Bitnami</a> <a href="/tags/%E9%98%B2%E7%81%AB%E5%A2%99/" style="font-size: 15px;">防火墙</a> <a href="/tags/firewalld/" style="font-size: 15px;">firewalld</a> <a href="/tags/Promtail/" style="font-size: 15px;">Promtail</a> <a href="/tags/Loki/" style="font-size: 15px;">Loki</a> <a href="/tags/Grafana/" style="font-size: 15px;">Grafana</a> <a href="/tags/%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1/" style="font-size: 15px;">日志服务</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/Harbor/" style="font-size: 15px;">Harbor</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 15px;">性能优化</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/1/16/JumpServer-Open-Source-Bastion-Deployment-and-Data-Migration/">JumpServer开源堡垒机的部署与数据迁移</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/1/3/Systemd-Services-Explained/">Systemd服务详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/27/MirrorZ-open-source-mirror-station-configuration-and-use/">MirrorZ开源镜像站的配置和使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/18/Why-do-you-often-feel-that-there-is-no-point-in-living/">为什么会经常觉得人活着没有意思</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/16/Configure-authorization-for-K8s-to-pull-harbor-repository-images/">配置K8s拉取私有Harbor仓库镜像的授权认证</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/9/Configuring-Cloud-Hosting-to-Connect-to-AliCloud-K8s/">配置云主机连接到阿里云K8s</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/5/Docker-based-single-node-deployment-of-cluster-mode-Nacos-services/">基于Docker的单节点部署集群模式Nacos服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/11/29/Build-Hexo-personal-blog-and-static-resource-file-management/">搭建Hexo个人博客和静态资源文件的管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/9/12/Configuring-Cloud-Hosting-to-Connect-to-AliCloud-K8s/">为Linux配置时区和同步互联网时间</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/9/4/Explain-firewall-cmd-firewall-rules-management-tool/">详解firewall-cmd防火墙规则管理工具</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://gitee.com/songdaoyuan" title="Gitee" target="_blank">Gitee</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">宋导的笔记本.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>